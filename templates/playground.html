{% extends "base.html" %}

{% block title %}Code Playground - NextGen Coders{% endblock %}

{% block content %}
<div class="container">
    <!-- Playground Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Domů</a></li>
                    <li class="breadcrumb-item active">Playground</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="playground-header">
                <div class="playground-icon">
                    <i class="fas fa-code text-success"></i>
                </div>
                <h1 class="playground-title">Code Playground</h1>
                <p class="playground-description">
                    Vyzkoušejte si Python nebo JavaScript kód přímo v prohlížeči!
                </p>
            </div>
        </div>
    </div>

    <!-- Language Tabs -->
    <div class="row mb-3">
        <div class="col-12">
            <ul class="nav nav-pills nav-fill bg-light p-2 rounded" id="languageTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="python-tab" data-bs-toggle="pill" 
                            data-bs-target="#python-playground" type="button" role="tab">
                        <i class="fab fa-python me-2"></i>Python
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="javascript-tab" data-bs-toggle="pill" 
                            data-bs-target="#javascript-playground" type="button" role="tab">
                        <i class="fab fa-js-square me-2"></i>JavaScript
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="playgroundTabContent">
        <!-- Python Playground -->
        <div class="tab-pane fade show active" id="python-playground" role="tabpanel">
            <div class="playground-container">
                <div class="code-editor-section">
                    <div class="editor-header">
                        <h5><i class="fab fa-python me-2 text-primary"></i>Python Editor</h5>
                        <div class="editor-actions">
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearPythonCode()">
                                <i class="fas fa-trash me-1"></i>Vymazat
                            </button>
                        </div>
                    </div>
                    <div class="code-editor">
                        <textarea id="pythonEditor" class="form-control" rows="15"># Napište svůj Python kód zde...
print("Ahoj, světe!")
print("Vítejte v Python Playground!")

# Zkuste něco jednoduchého:
for i in range(5):
    print(f"Počítám: {i + 1}")</textarea>
                    </div>
                    <div class="editor-footer">
                        <button class="btn btn-success btn-lg" onclick="runPython()">
                            <i class="fas fa-play me-2"></i>Spustit Python
                        </button>
                        <small class="text-muted ms-3">
                            <i class="fas fa-server me-1"></i>Běží na serveru (timeout 5s)
                        </small>
                    </div>
                </div>
                <div class="output-section">
                    <div class="output-header">
                        <h5><i class="fas fa-terminal me-2"></i>Výstup</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearPythonOutput()">
                            <i class="fas fa-trash me-1"></i>Vymazat
                        </button>
                    </div>
                    <div id="pythonOutput" class="output-content">
                        <div class="output-placeholder">
                            <i class="fas fa-play-circle text-muted"></i>
                            <p class="text-muted">Výstup vašeho Python kódu se zobrazí zde</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JavaScript Playground -->
        <div class="tab-pane fade" id="javascript-playground" role="tabpanel">
            <div class="playground-container">
                <div class="code-editor-section">
                    <div class="editor-header">
                        <h5><i class="fab fa-js-square me-2 text-warning"></i>JavaScript Editor</h5>
                        <div class="editor-actions">
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearJavaScriptCode()">
                                <i class="fas fa-trash me-1"></i>Vymazat
                            </button>
                        </div>
                    </div>
                    <div class="code-editor">
                        <textarea id="javascriptEditor" class="form-control" rows="15">// Napište svůj JavaScript kód zde...
console.log("Ahoj, světe!");
console.log("Vítejte v JavaScript Playground!");

// Zkuste něco jednoduchého:
for (let i = 0; i < 5; i++) {
    console.log(`Počítám: ${i + 1}`);
}</textarea>
                    </div>
                    <div class="editor-footer">
                        <button class="btn btn-warning btn-lg" onclick="runJavaScript()">
                            <i class="fas fa-play me-2"></i>Spustit JavaScript
                        </button>
                        <small class="text-muted ms-3">
                            <i class="fas fa-browser me-1"></i>Běží v prohlížeči (bezpečné)
                        </small>
                    </div>
                </div>
                <div class="output-section">
                    <div class="output-header">
                        <h5><i class="fas fa-terminal me-2"></i>Výstup</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearJavaScriptOutput()">
                            <i class="fas fa-trash me-1"></i>Vymazat
                        </button>
                    </div>
                    <div id="javascriptOutput" class="output-content">
                        <div class="output-placeholder">
                            <i class="fas fa-play-circle text-muted"></i>
                            <p class="text-muted">Výstup vašeho JavaScript kódu se zobrazí zde</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ====== PYTHON FUNCTIONS ======
function clearPythonCode() {
    document.getElementById('pythonEditor').value = '';
}

function clearPythonOutput() {
    document.getElementById('pythonOutput').innerHTML = `
        <div class="output-placeholder">
            <i class="fas fa-play-circle text-muted"></i>
            <p class="text-muted">Výstup vašeho Python kódu se zobrazí zde</p>
        </div>
    `;
}

async function runPython() {
    const code = document.getElementById('pythonEditor').value;
    const outputDiv = document.getElementById('pythonOutput');
    
    if (!code.trim()) {
        outputDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Napište nějaký kód před spuštěním!
            </div>
        `;
        return;
    }
    
    // Show loading
    outputDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Spouštím Python kód na serveru...</p>
        </div>
    `;
    
    try {
        const formData = new FormData();
        formData.append('code', code);
        
        const response = await fetch('/run_code', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        let outputHtml = '';
        
        if (result.error) {
            outputHtml = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Chyba:</strong><br>
                    <pre class="mb-0">${escapeHtml(result.error)}</pre>
                </div>
            `;
        } else if (result.output) {
            outputHtml = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Výstup:</strong><br>
                    <pre class="mb-0">${escapeHtml(result.output)}</pre>
                </div>
            `;
        } else {
            outputHtml = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Kód byl spuštěn úspěšně, ale nevypsal žádný výstup.
                </div>
            `;
        }
        
        outputDiv.innerHTML = outputHtml;
        
    } catch (error) {
        outputDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Chyba při spouštění:</strong><br>
                ${escapeHtml(error.message)}
            </div>
        `;
    }
}

// ====== JAVASCRIPT FUNCTIONS ======
function clearJavaScriptCode() {
    document.getElementById('javascriptEditor').value = '';
}

function clearJavaScriptOutput() {
    document.getElementById('javascriptOutput').innerHTML = `
        <div class="output-placeholder">
            <i class="fas fa-play-circle text-muted"></i>
            <p class="text-muted">Výstup vašeho JavaScript kódu se zobrazí zde</p>
        </div>
    `;
}

function runJavaScript() {
    const code = document.getElementById('javascriptEditor').value;
    const outputDiv = document.getElementById('javascriptOutput');
    
    if (!code.trim()) {
        outputDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Napište nějaký kód před spuštěním!
            </div>
        `;
        return;
    }
    
    // Clear output
    outputDiv.innerHTML = '';
    
    // Capture console output
    const logs = [];
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    console.log = (...args) => {
        logs.push({type: 'log', message: args.map(a => String(a)).join(' ')});
        originalLog.apply(console, args);
    };
    console.error = (...args) => {
        logs.push({type: 'error', message: args.map(a => String(a)).join(' ')});
        originalError.apply(console, args);
    };
    console.warn = (...args) => {
        logs.push({type: 'warn', message: args.map(a => String(a)).join(' ')});
        originalWarn.apply(console, args);
    };
    
    try {
        // Run the code
        eval(code);
        
        // Restore console
        console.log = originalLog;
        console.error = originalError;
        console.warn = originalWarn;
        
        // Display output
        if (logs.length > 0) {
            let outputHtml = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i><strong>Výstup:</strong><br><pre class="mb-0">';
            logs.forEach(log => {
                if (log.type === 'error') {
                    outputHtml += `<span class="text-danger">${escapeHtml(log.message)}</span>\n`;
                } else if (log.type === 'warn') {
                    outputHtml += `<span class="text-warning">${escapeHtml(log.message)}</span>\n`;
                } else {
                    outputHtml += `${escapeHtml(log.message)}\n`;
                }
            });
            outputHtml += '</pre></div>';
            outputDiv.innerHTML = outputHtml;
        } else {
            outputDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Kód byl spuštěn úspěšně, ale nevypsal žádný výstup.
                </div>
            `;
        }
        
    } catch (error) {
        // Restore console
        console.log = originalLog;
        console.error = originalError;
        console.warn = originalWarn;
        
        outputDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Chyba:</strong><br>
                <pre class="mb-0">${escapeHtml(error.toString())}</pre>
            </div>
        `;
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}

